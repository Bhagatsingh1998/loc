<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake of Cakes | User Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/all.css">
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/mega-menu.css">
    <link rel="stylesheet" href="../assets//css/randomStyles.css">
    <link rel="stylesheet" href="../assets/css/animate.css">
    <script src="https://ajax.aspnetcdn.com/ajax/modernizr/modernizr-2.7.2.js"></script>
    <link rel="stylesheet" href="assets/css/animation.css">
    <link rel="stylesheet" href="../assets/css/customerProfile.css">
</head>
<style>

</style>

<body style="overflow-x: hidden !important; " id="userBody">
    <section id="nav-section-loader"></section>
    <div class="main-content">
        <!-- Top navbar -->

        <!-- Header -->
        <div class="header pb-8 pt-5 pt-lg-8 d-flex align-items-center"
            style="min-height: 200px; background-image: url(https://raw.githack.com/creativetimofficial/argon-dashboard/master/assets/img/theme/profile-cover.jpg); background-size: cover; background-position: center top;">
            <!-- Mask -->
            <span class="mask bg-gradient-default opacity-8"></span>
            <!-- Header container -->
            <!-- <div class="container-fluid d-flex align-items-center">
        <div class="row">
          <div class="col-lg-7 col-md-10">
            <h1 class="display-2 text-white">Hello Jesse</h1>
             <p class="text-white mt-0 mb-5">This is your profile page. You can see the progress you've made with your work and manage your projects or assigned tasks</p>
            <a href="#!" class="btn btn-info">Edit profile</a> 
          </div>
        </div>
      </div>-->
        </div>

        <div class="container-fluid mt--7">
            <div class="row">
                <div class="col-xl-4 order-xl-2 mb-5 mb-xl-0">
                    <div class="card card-profile shadow">
                        <div class="row justify-content-center">
                            <div class="col-lg-3 order-lg-2">
                                <div class="card-profile-image">
                                    <a href="#! ">
                                        <img src="https://img.icons8.com/bubbles/2x/user-male.png" id="putImage"
                                            class=""
                                            style="width: 200px !important;height: 150px !important; object-fit: cover; border-radius: 100% !important;">

                                    </a>

                                </div>

                            </div>
                        </div>

                        <div class="card-header text-center border-0 pt-8 pt-md-4 pb-0 pb-md-4">
                            <div class="d-flex justify-content-between">
                                <a href="#!" class="btn btn-sm btn-info ">Delete Account</a>

                                <label for="fileSubmit2" class="btn btn-sm btn-default float-right"
                                    style="display: inline-block;background-color: rgb(170, 90, 90);color: #ffffff;">Update
                                    Image</label>
                                <input type="file" style="display: none;" accept="images/*" id="fileSubmit2"
                                    onchange="readURL(this)">

                            </div>
                        </div>
                        <section style="margin-left: auto;margin-right: auto;margin-top: 8%;">
                            <progress value="0" max="100" id="uploader2"> 0%</progress>
                            <p id="demo"></p>
                            <h5 style="font-size: 14px;padding: 10px;border-radius: 20px;color: palevioletred;font-weight: 900;display: none; "
                                id="profileMessage">Click on update button to update the profile pic</h5>
                        </section>
                        <div class="card-body pt-0 ">
                            <div class="row">
                                <div class="col"
                                    style="background-color: transparent !important;color: black !important;">
                                    <div class="card-profile-stats d-flex justify-content-center mt-md-5">
                                        <div>
                                            <span class="heading">10</span>
                                            <span class="description">Placed Orders</span>
                                        </div>
                                        <div>
                                            <span class="heading">5</span>
                                            <span class="description">Completed Orders</span>
                                        </div>
                                        <div>
                                            <span class="heading">5</span>
                                            <span class="description">Pending Orders</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h3 id="dbName">
                                    Loading...
                                </h3>
                                <!-- <div class="h5 font-weight-300">
                  <i class="ni location_pin mr-2"></i>Bucharest, Romania
                </div> -->
                                <div class="h5 mt-4" id="dbEmail">
                                    <i class="ni business_briefcase-24 mr-2"></i>Loading...
                                </div>
                                <!-- <div>
                  <i class="ni education_hat mr-2"></i>University of Computer Science
                </div> -->
                                <hr class="my-4">
                                <p style="font-weight: 900;">All Orders</p>
                                <div class="mr-table allproduct mt-4" style="max-height: 300px;overflow-x: auto;">
                                    <div class="table-responsiv">
                                        <table id="" class="table table-hover dt-responsive" cellspacing="0"
                                            width="100%">
                                            <thead>
                                                <tr>
                                                    <th>Order Id</th>
                                                    <th>Image</th>
                                                    <th>Order Total</th>
                                                    <th>Order Status</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        1232
                                                    </td>
                                                    <td>
                                                        <img src="../assets/images/flowerbg.jpg" width="70">
                                                    </td>
                                                    <td>
                                                        300
                                                    </td>
                                                    <td>
                                                        Rejected
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        12232
                                                    </td>
                                                    <td>
                                                        <img src="../assets/images/flowerbg.jpg" width="70">
                                                    </td>
                                                    <td>
                                                        300
                                                    </td>
                                                    <td>
                                                        Pending
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        12232
                                                    </td>
                                                    <td>
                                                        <img src="../assets/images/flowerbg.jpg" width="70">
                                                    </td>
                                                    <td>
                                                        300
                                                    </td>
                                                    <td>
                                                        Completed
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        12232
                                                    </td>
                                                    <td>
                                                        <img src="../assets/images/flowerbg.jpg" width="70">
                                                    </td>
                                                    <td>
                                                        300
                                                    </td>
                                                    <td>
                                                        Pending
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-8 order-xl-1">
                    <div class="card bg-secondary shadow">
                        <div class="card-header bg-white border-0">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <h3 class="mb-0">My account</h3>
                                </div>
                                <div class="col-4 text-right">
                                    <a href="#1" class="btn btn-sm btn-primary" id="updateDetails">Update</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <form>
                                <h6 class="heading-small text-muted mb-4">User information</h6>
                                <h5 style="text-align: center;padding: 10px;color: #ffffff;display: none;" id="message">
                                    Loading..</h5>

                                <div class="pl-lg-4">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="input-username">Username</label>
                                                <input type="text" id="username"
                                                    class="form-control form-control-alternative" placeholder="Username"
                                                    value="">
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="form-group">
                                                <label class="form-control-label" for="input-email">Email
                                                    address</label>
                                                <input type="email" id="useremail"
                                                    class="form-control form-control-alternative"
                                                    placeholder="demo@example.com">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="input-first-name">Phone
                                                    Number</label>
                                                <input type="number" id="phone2"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Update your Phone Number" value="">
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="">Alt. Phone Number</label>
                                                <input type="number" id="altphone"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Confirm Updated Alternate Phone Number" value="">
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="input-first-name"
                                                    id="lblcurrpass">Current
                                                    Password</label>
                                                <input type="password" id="currpass"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Update your password" value="">
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="input-first-name"
                                                    id="lblpass">New Password</label>
                                                <input type="password" id="pass"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Update your password" value="">
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="input-last-name"
                                                    id="lblcpass">Confirm
                                                    Password</label>
                                                <input type="password" id="cpass"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Confirm Updated Password" value="">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4">
                                <!-- Address -->
                                <h6 class="heading-small text-muted mb-4">Address Details</h6>
                                <div class="pl-lg-4">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="address">Address</label>
                                                <input id="address" class="form-control form-control-alternative"
                                                    placeholder="Home Address"
                                                    value="Bld Mihail Kogalniceanu, nr. 8 Bl 1, Sc 1, Ap 09"
                                                    type="text">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="city">City</label>
                                                <input type="text" id="city"
                                                    class="form-control form-control-alternative" placeholder="City"
                                                    value="New York">
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group focused">
                                                <label class="form-control-label" for="Landmark">Landmark</label>
                                                <input type="text" id="landmark"
                                                    class="form-control form-control-alternative" placeholder="Landmark"
                                                    value="United States">
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group">
                                                <label class="form-control-label" for="postal">Postal
                                                    code</label>
                                                <input type="number" id="postal"
                                                    class="form-control form-control-alternative"
                                                    placeholder="Postal code">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- SECTION1 -->


    <footer class="footer" id="footer-section-loader" style="background:rgba(10, 46, 100, 0.6);"></footer>

    <script src="../assets/js/jquery.js"></script>
    <!-- <script src="../assets/js/jquery-ui.min.js"></script> -->
    <script type="text/javascript">
        // $(document).ready(() => {
        $('#nav-section-loader').load('../Common/navbar.html');
        $('#footer-section-loader').load('../Common/footer.html');
    // })
    </script>
    <script type="text/javascript">
        setTimeout(() => {
            $('#footer-section-loader').load('../Common/files.html');
        }, 3000);
    </script>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/7.24.0/firebaseui.js"></script> -->
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyATUjzcsSQMIKlEeBQqMGTy_4zugRTPILg",
            authDomain: "lake-of-cakes.firebaseapp.com",
            databaseURL: "https://lake-of-cakes.firebaseio.com",
            projectId: "lake-of-cakes",
            storageBucket: "lake-of-cakes.appspot.com",
            messagingSenderId: "779843608951",
            appId: "1:779843608951:web:48c6afe1773e2b395e8172",
            measurementId: "G-5ER0QF0FDW"
        };
        firebase.initializeApp(firebaseConfig);
        // firebase.analytics();
        var db = firebase.firestore();
    </script>

    <!-- <script src="../index1.js"></script> -->
    <script src="../Common/navbar1.js"></script>
    <script>
        var user = window.localStorage.getItem("locLoggedInUser");
        var userKey = "null";



        if (user != "null" && user != null) {

            var userimage = "null";
            var updatedPhone = "false";
            var dbref = db.collection('Customers');
            db.collection("Customers").onSnapshot(async (snapshots) => {

                let snapshotDocs = snapshots.docs;
       
                for (let doc of snapshotDocs) {

                    let docData = doc.data();
                    if (user == docData.userId) {
                        userKey = docData;
                        break;
                    }

                }
                if (userKey != "null") {
                    var dbref = db.collection('Customers');
                    document.getElementById("dbName").innerHTML = userKey.UserName;
                    document.getElementById("dbEmail").innerHTML = userKey.Email
                    document.getElementById("username").value = userKey.UserName;
                    document.getElementById("useremail").value = userKey.Email;
                    if (userKey.Password == undefined) {
                        document.getElementById("pass").style.display = "none"
                        document.getElementById("cpass").style.display = "none"
                        document.getElementById("currpass").style.display = "none"
                        document.getElementById("lblcurrpass").style.display = "none"
                        document.getElementById("lblpass").style.display = "none"
                        document.getElementById("lblcpass").style.display = "none"
                    } else {
                        document.getElementById("pass").style.display = "block"
                        document.getElementById("cpass").style.display = "block"
                        document.getElementById("currpass").style.display = "block"
                        document.getElementById("lblcurrpass").style.display = "block"
                        document.getElementById("lblpass").style.display = "block"
                        document.getElementById("lblcpass").style.display = "block"
                    }

                    if (userKey.Phone == undefined || userKey.Phone == null) {

                        document.getElementById("phone2").value = "";
                    } else {

                        document.getElementById("phone2").value = userKey.Phone.slice(userKey.Phone.length - 10);

                    }
                    if (userKey.AltPhone == undefined) {
                        document.getElementById("altphone").value = "";
                    } else {
                        document.getElementById("altphone").value = userKey.AltPhone;
                    }
                    if (userKey.Address == undefined) {
                        document.getElementById("address").value = "";
                    } else {
                        document.getElementById("address").value = userKey.Address;
                    }

                    if (userKey.City == undefined) {
                        document.getElementById("city").value = "";
                    } else {
                        document.getElementById("city").value = userKey.City;
                    }

                    if (userKey.Landmark == undefined) {
                        document.getElementById("landmark").value = "";
                    } else {
                        document.getElementById("landmark").value = userKey.Landmark;
                    }

                    if (userKey.Postal == undefined) {
                        document.getElementById("postal").value = "";
                    } else {
                        document.getElementById("postal").value = userKey.Postal;
                    }

                    if (userKey.Image == undefined || userKey.Image == null || userKey.Image == "null") {
                        document.getElementById("putImage").src = "https://w7.pngwing.com/pngs/81/570/png-transparent-profile-logo-computer-icons-user-user-blue-heroes-logo.png"
                    } else {
                        document.getElementById("putImage").src = userKey.Image;
                    }


                    document.getElementById("updateDetails").addEventListener("click", async function () {
                        let check = 0;

                        let name = document.querySelector('#username').value;
                        let email = document.querySelector('#useremail').value;
                        let pass = document.querySelector('#pass').value;
                        let currpass = document.querySelector('#currpass').value;
                        let cpass = document.querySelector('#cpass').value;
                        let phone = document.querySelector('#phone2').value;
                        let altphone = document.querySelector('#altphone').value;
                        let address = document.querySelector('#address').value;
                        let city = document.querySelector('#city').value;
                        let postal = document.querySelector('#postal').value;
                        let landmark = document.querySelector('#landmark').value;


                        if (phone != "" && altphone != "") {
                            if (phone.length == 10 && altphone.length == 10) {
                                if (selectedFile == "null") {
                                    userimage = userKey.Image;
                                } else {
                                    await sendimage2();
                                    console.log(userimage)
                                }
                                await dbref.doc(userKey.userId).update({
                                    UserName: name,
                                    Email: email,
                                    Image: userimage,
                                    Phone: phone,
                                    AltPhone: altphone,
                                    Address: address,
                                    City: city,
                                    Postal: postal,
                                    Landmark: landmark

                                }).then(function () {
                                    document.getElementById("message").style.display = "block";
                                    document.getElementById("message").style.backgroundColor = "green"
                                    document.getElementById("message").innerHTML = "Data Updated Successfully"

                                    setTimeout(function () {

                                        document.getElementById("message").style.display = "none";
                                    }, 2000)
                                });
                            } else {
                                document.getElementById("message").style.display = "block";
                                document.getElementById("message").style.backgroundColor = "red"
                                document.getElementById("message").innerHTML = "Invalid Phone numbers"

                                setTimeout(function () {

                                    document.getElementById("message").style.display = "none";
                                }, 2000)
                            }
                        } else {
                            if (selectedFile == "null") {
                                userimage = userKey.Image;
                            } else {
                                await sendimage2();
                                console.log(userimage)
                            }
                            await dbref.doc(userKey.userId).update({
                                UserName: name,
                                Email: email,
                                Image: userimage,
                                Phone: phone,
                                City: city,
                                Postal: postal,
                                Landmark: landmark

                            }).then(function () {
                                document.getElementById("message").style.display = "block";
                                document.getElementById("message").style.backgroundColor = "green"
                                document.getElementById("message").innerHTML = "Data Updated Successfully"

                                setTimeout(function () {

                                    document.getElementById("message").style.display = "none";
                                }, 2000)
                            });
                        }

                        if (currpass.trim() != "") {

                            if (currpass.trim() == atob(userKey.Password)) {
                                if ((pass.trim() == cpass.trim()) && (cpass.trim() != "" && pass.trim() != "")) {
                                    if (selectedFile == "null") {
                                        userimage = userKey.Image;
                                    } else {
                                        await sendimage2();
                                        alert("9")
                                    }
                                    await dbref.doc(userKey.userId).update({
                                        UserName: name,
                                        Email: email,
                                        Image: userimage,
                                        Password: btoa(pass),
                                        Phone: phone,
                                        City: city,
                                        Postal: postal,
                                        Landmark: landmark

                                    }).then(function () {
                                        document.getElementById("message").style.display = "block";
                                        document.getElementById("message").style.backgroundColor = "green"
                                        document.getElementById("message").innerHTML = "Data Updated Successfully"

                                        setTimeout(function () {

                                            document.getElementById("message").style.display = "none";
                                        }, 2000)
                                    });
                                } else {
                                    document.getElementById("message").style.display = "block";
                                    document.getElementById("message").style.backgroundColor = "red"
                                    document.getElementById("message").innerHTML = "Password Miss-Match"

                                    setTimeout(function () {

                                        document.getElementById("message").style.display = "none";
                                    }, 2000)

                                }
                            }
                            else {

                                document.getElementById("message").style.display = "block";
                                document.getElementById("message").style.backgroundColor = "red"
                                document.getElementById("message").innerHTML = "Current Password Incorrect"

                                setTimeout(function () {

                                    document.getElementById("message").style.display = "none";
                                }, 2000)

                            }
                        }

                    });
                }
            });
            var selectedFile = "null";
            var uploader = document.getElementById('uploader2');
            fileSubmit2.addEventListener('change', uploadFile2);
            function uploadFile2(e) {
                selectedFile = e.target.files[0];

            }

            async function sendimage2() {
                const storageService = firebase.storage();
                var uploadTask = storageService.ref("UserProfileImages/"+userKey.userId+"/"+selectedFile.name+"").put(selectedFile);
                console.log(selectedFile.getDownloadURL);
                await uploadTask.on('state_changed', function (snapshot) {
                    var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploader.value = percentage;
                    progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;

                    document.getElementById("demo").innerHTML = progress;
                    switch (snapshot.state) {
                        case firebase.storage.TaskState.PAUSED: // or 'paused'
                            document.getElementById("demo").innerHTML = "Upload Paused";
                            console.log('Upload is paused');
                            break;
                        case firebase.storage.TaskState.RUNNING: // or 'running'
                            document.getElementById("demo").innerHTML = "File is uploading" + " " + progress + "%";

                            break;
                    }
                }, function (error) {
                    console.log(error);
                    // Handle unsuccessful uploads
                }, function () {
                    document.getElementById("demo").innerHTML = "Uploaded" + " " + progress + "%";
                    uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {

                        urls2 = downloadURL;

                        userimage = urls2;

                        dbref.doc(userKey.userId).update({
                        
                            Image: userimage,
                           

                        });

                        // window.location="CrewDetails.html"
                    });
                });

            }

        } else {
            document.getElementById("userBody").innerHTML = "404 Not Found"
            window.location = "/Auth/login.html"
        }


        function readURL(input) {
            document.getElementById("profileMessage").style.display = "block";
            setInterval(function () {
                document.getElementById("profileMessage").style.display = "none";
            }, 3000)
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#putImage')
                        .attr('src', e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>



    
</html>